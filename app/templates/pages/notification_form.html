{% extends "base.html" %}

{% block title %}{{ "Edit" if editing else "New" }} Alert â€“ Tennis Court Finder{% endblock %}

{% block content %}
<hgroup>
  <h1>{{ "Edit" if editing else "New" }} Alert</h1>
  <p>{{ "Update your notification settings" if editing else "Get notified when a court slot becomes available" }}</p>
</hgroup>

<form method="post"
      action="{{ '/notifications/' ~ sub.id ~ '/edit' if editing else '/notifications/new' }}">

  <!-- â”€â”€ Club(s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  {% if editing %}
  {# Edit mode: single club select (one subscription = one club) #}
  <label>
    Club
    <select name="club_id" required
            hx-get="/partials/club-courts"
            hx-target="#court-picker"
            hx-trigger="change"
            hx-vals='js:{"club_ids": [event.target.value]}'>
      <option value="">Select a clubâ€¦</option>
      {% for club in clubs %}
      <option value="{{ club.id }}"
              {% if sub.club_id == club.id %}selected{% endif %}>
        {{ club.name }}
      </option>
      {% endfor %}
    </select>
  </label>
  {% else %}
  {# Create mode: multi-club checkboxes #}
  <fieldset>
    <legend>Clubs</legend>
    <div style="display:flex; flex-wrap:wrap; gap:0.5rem 1.5rem;">
      {% for club in clubs %}
      <label>
        <input type="checkbox" name="club_ids" value="{{ club.id }}"
               {% if selected_club_ids and club.id in selected_club_ids %}checked{% endif %}
               hx-get="/partials/club-courts"
               hx-target="#court-picker"
               hx-trigger="change"
               hx-include="[name='club_ids']">
        {{ club.name }}
      </label>
      {% endfor %}
    </div>
  </fieldset>
  {% endif %}

  <!-- â”€â”€ Courts (loaded dynamically) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="court-picker">
    {% if court_groups %}
    {% include "partials/court_picker.html" %}
    {% endif %}
  </div>

  <!-- â”€â”€ Notify on statuses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <fieldset>
    <legend>Notify me when a slot becomesâ€¦</legend>
    <div style="display:flex; gap:1.5rem;">
      <label>
        <input type="checkbox" name="notify_on_statuses" value="free"
               {% if not editing or 'free' in sub.notify_on_statuses %}checked{% endif %}>
        ðŸŸ¢ Free
      </label>
      <label>
        <input type="checkbox" name="notify_on_statuses" value="for_sale"
               {% if editing and 'for_sale' in sub.notify_on_statuses %}checked{% endif %}>
        ðŸŸ  For Sale
      </label>
    </div>
  </fieldset>

  <!-- â”€â”€ Time range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <fieldset>
    <legend>Preferred time window</legend>
    <div class="grid">
      <label>
        From
        <input type="time" name="time_from"
               value="{{ sub.time_from if editing and sub.time_from else '08:00' }}">
      </label>
      <label>
        To
        <input type="time" name="time_to"
               value="{{ sub.time_to if editing and sub.time_to else '22:00' }}">
      </label>
    </div>
  </fieldset>

  <!-- â”€â”€ Schedule type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <fieldset>
    <legend>Schedule</legend>
    <div style="display:flex; gap:1.5rem; margin-bottom:0.5rem;">
      <label>
        <input type="radio" name="is_recurring" value="true"
               {% if not editing or sub.is_recurring %}checked{% endif %}
               onclick="document.getElementById('recurring-opts').style.display='block'; document.getElementById('onetime-opts').style.display='none';">
        ðŸ“… Weekly recurring
      </label>
      <label>
        <input type="radio" name="is_recurring" value="false"
               {% if editing and not sub.is_recurring %}checked{% endif %}
               onclick="document.getElementById('recurring-opts').style.display='none'; document.getElementById('onetime-opts').style.display='block';">
        ðŸ“Œ Specific dates
      </label>
    </div>
  </fieldset>

  <!-- â”€â”€ Recurring: days of week â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="recurring-opts"
       style="{% if editing and not sub.is_recurring %}display:none{% endif %}">
    <fieldset>
      <legend>Days of the week</legend>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem 1.2rem;">
        {% for day in ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'] %}
        <label>
          <input type="checkbox" name="days_of_week" value="{{ day }}"
                 {% if editing and sub.days_of_week and day in sub.days_of_week %}checked{% endif %}
                 {% if not editing and day in ['tuesday', 'thursday'] %}checked{% endif %}>
          {{ day | title }}
        </label>
        {% endfor %}
      </div>
    </fieldset>
  </div>

  <!-- â”€â”€ One-time: specific dates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="onetime-opts"
       style="{% if not editing or sub.is_recurring %}display:none{% endif %}">
    <label>
      Specific dates
      <input type="text" name="specific_dates" id="specific-dates-input"
             placeholder="Click to pick datesâ€¦"
             value="{% if editing and sub.specific_dates %}{{ sub.specific_dates | join(', ') }}{% endif %}">
    </label>
  </div>

  <!-- â”€â”€ Surface & court type filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <details>
    <summary>Advanced filters (surface type, indoor/outdoor)</summary>

    <fieldset>
      <legend>Surface types <small class="text-muted">(optional)</small></legend>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem 1.2rem;">
        {% for st in surface_types %}
        <label>
          <input type="checkbox" name="surface_types" value="{{ st }}"
                 {% if editing and sub.surface_types and st in sub.surface_types %}checked{% endif %}>
          {{ st | replace('_', ' ') | title }}
        </label>
        {% endfor %}
      </div>
    </fieldset>

    <fieldset>
      <legend>Court type <small class="text-muted">(optional)</small></legend>
      <div style="display:flex; gap:1.5rem;">
        {% for ct in court_types %}
        <label>
          <input type="checkbox" name="court_types" value="{{ ct }}"
                 {% if editing and sub.court_types and ct in sub.court_types %}checked{% endif %}>
          {{ ct | title }}
        </label>
        {% endfor %}
      </div>
    </fieldset>
  </details>

  <!-- â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="grid" style="margin-top:1rem;">
    <button type="submit">{{ "Save Changes" if editing else "Create Alert" }}</button>
    <a href="/notifications" role="button" class="outline secondary" style="text-align:center;">Cancel</a>
  </div>
</form>

{% endblock %}

{% block scripts %}
<script>
  // Flatpickr for date picking
  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('specific-dates-input');
    if (input) {
      flatpickr(input, {
        mode: 'multiple',
        dateFormat: 'Y-m-d',
        minDate: 'today',
        conjunction: ', ',
      });
    }
  });
</script>
{% endblock %}
